<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Emoji Flip</title>
  <style>
    body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
    canvas { display: block; }
    #ui {
      position: absolute;
      top: 10px;
      left: 50%; /* Center horizontally */
      transform: translateX(-50%); /* Adjust for element width */
      color: white;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 5px;
      z-index: 10; /* Ensure UI is above messages */
      text-align: center; /* Center text inside the div */
    }
    .temporary-message {
      position: absolute;
      bottom: 5%; /* Lower initial position */
      left: 50%;
      transform: translateX(-50%) translateY(0) scale(0.8); /* Center horizontally, start at bottom, slightly smaller */
      color: white;
      font-size: 1.8em; /* Slightly smaller text */
      font-weight: bold;
      text-align: center;
      background: rgba(0, 0, 0, 0.75);
      padding: 15px 50px; /* Increased horizontal padding */
      border-radius: 10px;
      opacity: 0;
      transition: opacity 0.5s ease-out, transform 0.8s cubic-bezier(0.25, 0.8, 0.25, 1); /* Smooth fade, scale, and upward movement */
      pointer-events: none; /* Don't interfere with interactions */
      z-index: 5; /* Below main UI but above canvas */
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5); /* Add shadow for readability */
    }
    .temporary-message.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-150%) scale(1); /* Center horizontally, move upwards, scale to full size */
    }
  </style>
</head>
<body>
  <div id="ui">
    <div>Current Streak: <span id="streak">0</span></div>
    <div>Highest Streak: <span id="highestStreak">0</span></div>
  </div>

  <!-- Temporary Message Elements -->
  <div id="swipePrompt" class="temporary-message">Swipe to flip!</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
  <script>
    const scene=new THREE.Scene,groundColor="#b5e2fa",cylinderColor="#4e99ce";scene.background=new THREE.Color(groundColor);const camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),originalCameraPosition=new THREE.Vector3(0,3,5);camera.position.copy(originalCameraPosition),camera.lookAt(0,0,1.5);const renderer=new THREE.WebGLRenderer({antialias:!0});renderer.setPixelRatio(Math.min(window.devicePixelRatio,1.5)),renderer.setSize(window.innerWidth,window.innerHeight),renderer.shadowMap.enabled=!0,document.body.appendChild(renderer.domElement);const ambientLight=new THREE.AmbientLight(16777215,.4);scene.add(ambientLight);const directionalLight=new THREE.DirectionalLight(16251644,.7);directionalLight.position.set(.6,5,-5),directionalLight.castShadow=!0,directionalLight.shadow.camera.far=50,directionalLight.shadow.mapSize.width=1024,directionalLight.shadow.mapSize.height=1024,directionalLight.shadow.radius=5,scene.add(directionalLight);const lightTarget=new THREE.Object3D;lightTarget.position.set(3,-1,3),scene.add(lightTarget),directionalLight.target=lightTarget;const world=new CANNON.World;function createGroundTexture(){let e=document.createElement("canvas");e.width=2048,e.height=2048;let t=e.getContext("2d");t.fillStyle=groundColor,t.fillRect(0,0,e.width,e.height),t.save(),t.translate(e.width/2,e.height/2),t.rotate(20*Math.PI/180),t.fillStyle="#000000",t.font='bold 100px "Roboto", sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText("flip",0,0),t.strokeStyle="#000000",t.lineWidth=5;let r=t.measureText("flip"),a=r.width;t.strokeRect(-a/2-10,-60,a+20,120),t.restore();let i=new THREE.CanvasTexture(e);return i.offset.set(.495,.495),i.wrapS=THREE.ClampToEdgeWrapping,i.wrapT=THREE.ClampToEdgeWrapping,i}function createCylinderTexture(){let e=document.createElement("canvas");e.width=1024,e.height=1024;let t=e.getContext("2d");t.fillStyle=cylinderColor,t.fillRect(0,0,e.width,e.height),t.save(),t.translate(e.width/2,e.height/2),t.rotate(270*Math.PI/180),t.restore();let r=new THREE.CanvasTexture(e);return r.wrapS=THREE.RepeatWrapping,r.wrapT=THREE.RepeatWrapping,r.repeat.set(1,1),r}world.gravity.set(0,-19.62,0);const groundMesh=new THREE.Mesh(new THREE.PlaneGeometry(500,500),new THREE.MeshStandardMaterial({map:createGroundTexture(),color:groundColor}));groundMesh.rotation.x=-Math.PI/2,groundMesh.receiveShadow=!0,scene.add(groundMesh);const groundBody=new CANNON.Body({mass:0,shape:new CANNON.Plane,material:new CANNON.Material});groundBody.quaternion.setFromEuler(-Math.PI/2,0,0),world.addBody(groundBody);const cylinderMesh=new THREE.Mesh(new THREE.CylinderGeometry(2,2,3,64),new THREE.MeshStandardMaterial({color:cylinderColor,map:createCylinderTexture(),metalness:0,roughness:.5}));cylinderMesh.position.set(0,-1,0),cylinderMesh.castShadow=!0,cylinderMesh.receiveShadow=!0,scene.add(cylinderMesh);const cylinderShape=new CANNON.Cylinder(2,2,3,64),cylinderBody=new CANNON.Body({mass:0,shape:cylinderShape,material:new CANNON.Material});cylinderBody.position.set(0,-1,0);const quat=new CANNON.Quaternion;quat.setFromAxisAngle(new CANNON.Vec3(1,0,0),Math.PI/2),cylinderShape.transformAllPoints(new CANNON.Vec3,quat),world.addBody(cylinderBody);let streak=0,highestStreak=0,streakMaterials=[],grimaceMaterials=[],flippingMaterials=[],previousStreak=0,messageTimeout=null;const emojiSequence=["\uD83D\uDE42","\uD83D\uDE0A","\uD83D\uDE03","\uD83D\uDE04","\uD83D\uDE01","\uD83D\uDE06","\uD83D\uDE0E","\uD83D\uDE2E","\uD83D\uDE2F","\uD83D\uDE32","\uD83D\uDE33","\uD83E\uDD29","\uD83D\uDE35","\uD83E\uDD73","\uD83E\uDD2A","\uD83D\uDE31","\uD83E\uDD2F"],grimaceEmoji="\uD83D\uDE22",flippingEmoji="\uD83D\uDE2C";function createTextTexture(e){let t=document.createElement("canvas");t.width=1024,t.height=1024;let r=t.getContext("2d");r.fillStyle="#FFFFFF",r.fillRect(0,0,t.width,t.height),r.fillStyle="#2d3748",r.font="800px Arial",r.textAlign="center",r.textBaseline="middle",r.fillText(e,t.width/2,t.height/2+.05*t.height);let a=new THREE.CanvasTexture(t);return{colorTexture:a}}const swipePromptEl=document.getElementById("swipePrompt"),streakEl=document.getElementById("streak");function showTemporaryMessage(e,t,r=1500){messageTimeout&&e===swipePromptEl&&clearTimeout(messageTimeout),e.textContent=t,e.classList.add("show"),messageTimeout=e!==swipePromptEl?setTimeout(()=>{e.classList.remove("show"),messageTimeout=null},r):setTimeout(()=>{e.classList.remove("show"),messageTimeout=null},2500)}function createMaterialsFromText(e){let t=createTextTexture(e);return[new THREE.MeshStandardMaterial({color:"#FFFFFF",metalness:0,roughness:.15}),new THREE.MeshStandardMaterial({map:t.colorTexture,metalness:0,roughness:.15}),new THREE.MeshStandardMaterial({map:createEmojiFlipTexture(),metalness:0,roughness:.15})]}function createEmojiFlipTexture(){let e=document.createElement("canvas");e.width=1024,e.height=1024;let t=e.getContext("2d");t.fillStyle="#FFFFFF",t.fillRect(0,0,e.width,e.height),t.save(),t.translate(e.width/2,e.height/2),t.rotate(180*Math.PI/180),t.restore();let r=new THREE.CanvasTexture(e);return r.wrapS=THREE.ClampToEdgeWrapping,r.wrapT=THREE.ClampToEdgeWrapping,r}function updateStreakMaterials(){let e=streak,t=emojiSequence[Math.min(e,emojiSequence.length-1)];streakMaterials=createMaterialsFromText(t)}grimaceMaterials=createMaterialsFromText("\uD83D\uDE22"),flippingMaterials=createMaterialsFromText("\uD83D\uDE2C"),updateStreakMaterials();const coins=[];let isCoinSettled=!0,flipStartTime=0;function createCoin(e=10,t=2,r=0,a=50){try{coins.forEach(({mesh:e,body:t})=>{scene.remove(e),world.remove(t)}),coins.length=0;let i=new THREE.Mesh(new THREE.CylinderGeometry(.5,.5,.1,32),flippingMaterials);i.castShadow=!0,i.receiveShadow=!0,scene.add(i);let n=new CANNON.Cylinder(.5,.5,.1,32),o=new CANNON.Quaternion;o.setFromAxisAngle(new CANNON.Vec3(1,0,0),Math.PI/2),n.transformAllPoints(new CANNON.Vec3,o);let l=new CANNON.Body({mass:10,shape:n,material:new CANNON.Material});l.position.set(0,1,4),l.velocity.set(r,e,t),l.angularVelocity.set(Math.min(Math.random()*a,-25),(Math.random()-.5)*a*.1,(Math.random()-.5)*a*.1),world.addBody(l);let s=new CANNON.ContactMaterial(groundBody.material,l.material,{friction:.001,restitution:.003}),d=new CANNON.ContactMaterial(cylinderBody.material,l.material,{friction:.001,restitution:.003});world.addContactMaterial(s),world.addContactMaterial(d),coins.push({mesh:i,body:l}),isCoinSettled=!1,flipStartTime=performance.now(),console.log("Coin created")}catch(c){console.error("Error creating coin:",c)}}function checkCoinResult(){if(0===coins.length||isCoinSettled)return;let e=coins[coins.length-1],t=e.body.velocity,r=e.body.angularVelocity,a=streak;if(!isCoinSettled&&.1>Math.abs(t.x)&&.1>Math.abs(t.y)&&.1>Math.abs(t.z)&&.1>Math.abs(r.x)&&.1>Math.abs(r.y)&&.1>Math.abs(r.z)){isCoinSettled=!0,console.log("Coin settled, checking result...");try{let i=new THREE.Vector3(0,1,0),n=i.applyQuaternion(e.mesh.quaternion),o=n.dot(new THREE.Vector3(0,1,0)),l=o>0?"H":"T",s=o>0?"\uD83D\uDE0A":"‚ùå",d=!1,c=!1;world.contacts.forEach(t=>{let r=t.bi,a=t.bj;(r===e.body&&a===cylinderBody||r===cylinderBody&&a===e.body)&&(d=!0),(r===e.body&&a===groundBody||r===groundBody&&a===e.body)&&(c=!0)}),console.log(`Contacts: Cylinder=${d}, Ground=${c}`),setTimeout(()=>{if(!e.mesh||!scene.getObjectById(e.mesh.id)){console.log("Coin removed before result processing timeout.");return}let t=s,r=!1;"H"===l?d&&!c?(a=streak,streak++,r=!0,streak>highestStreak&&(highestStreak=streak,document.getElementById("highestStreak").textContent=highestStreak),updateStreakMaterials(),e.mesh.material=streakMaterials,t=`üòä (Streak ${streak})`):(streak>0&&(r=!0),streak=0,e.mesh.material=grimaceMaterials,t=`üò¢ (Heads on Ground)`):(streak>0&&(r=!0),streak=0,e.mesh.material=grimaceMaterials,t=`üò¢ (Tails)`),r?0===streak?streakEl.innerHTML="‚ùå":streak<=3?streakEl.innerHTML="‚úÖ".repeat(streak):streakEl.innerHTML="‚úÖ".repeat(3)+"\uD83D\uDD25".repeat(streak-3):0===streak&&(streakEl.innerHTML="0"),console.log(`Processed result: ${t}, Streak: ${streak}, Highest Streak: ${highestStreak}`)},500)}catch($){console.error("Error checking coin result:",$)}}!isCoinSettled&&performance.now()-flipStartTime>11e3&&(console.warn("Coin failed to settle physically, forcing settlement state."),isCoinSettled=!0,e.mesh&&scene.getObjectById(e.mesh.id)&&(e.mesh.material=grimaceMaterials))}let touchStartX=null,touchStartY=null,touchStartTime=null;window.addEventListener("touchstart",e=>{let t=e.touches[0];touchStartX=t.clientX,touchStartY=t.clientY,touchStartTime=performance.now()}),window.addEventListener("touchend",e=>{if(null===touchStartY||null===touchStartX)return;let t=e.changedTouches[0],r=t.clientX-touchStartX,a=touchStartY-t.clientY,i=(performance.now()-touchStartTime)/1e3,n=a/i/100,o=r/i/300;if(isCoinSettled||(streak=0,streakEl.innerHTML="0",console.log("Swipe during flip detected, streak reset.")),a>30){let l=Math.min(10*n,150);createCoin(.5*n,-.3*n,o,l)}touchStartX=null,touchStartY=null,touchStartTime=null});let lastTime=performance.now(),frameCount=0,lastFpsUpdateTime=performance.now();function animate(){try{requestAnimationFrame(animate);let e=performance.now(),t=(e-lastTime)/1e3;lastTime=e,frameCount++,e>lastFpsUpdateTime+1e3&&(lastFpsUpdateTime=e,frameCount=0),world.step(1/120,t),coins.forEach(({mesh:e,body:t})=>{e.position.copy(t.position),e.quaternion.copy(t.quaternion)}),checkCoinResult(),renderer.render(scene,camera)}catch(r){console.error("Error in animate loop:",r)}}animate(),window.addEventListener("resize",()=>{camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}),window.onload=()=>{setTimeout(()=>{showTemporaryMessage(swipePromptEl,"Swipe to flip!")},500)};
  </script>
</body>
</html>
